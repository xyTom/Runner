name: agent-runner

on:
  workflow_dispatch:
    inputs:
      fork_repo:
        description: "Fork repo, e.g. agent-bot/some-repo"
        required: true
      upstream_repo:
        description: "Upstream repo, e.g. vercel/next.js"
        required: true
      prompt:
        description: "What to change"
        required: true
      job_id:
        description: "Job identifier for tracking"
        required: true
      callback_url:
        description: "URL to POST results when job completes (optional)"
        required: false
        default: ""


jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Prevent duplicate runs for the same job_id
    concurrency:
      group: agent-runner-${{ inputs.job_id }}
      cancel-in-progress: false

    env:
      # Pass inputs as environment variables for Python scripts
      FORK_REPO: ${{ inputs.fork_repo }}
      UPSTREAM_REPO: ${{ inputs.upstream_repo }}
      AGENT_PROMPT: ${{ inputs.prompt }}
      JOB_ID: ${{ inputs.job_id }}
      CALLBACK_URL: ${{ inputs.callback_url }}
      # Secrets and vars
      BOT_TOKEN: ${{ secrets.BOT_TOKEN }}
      LLM_API_KEY: ${{ secrets.LLM_API_KEY }}
      LLM_MODEL: ${{ vars.LLM_MODEL }}
      LLM_BASE_URL: ${{ vars.LLM_BASE_URL }}
      WEBHOOK_SECRET: ${{ secrets.WEBHOOK_SECRET }}

    steps:
      # ========================================
      # Setup
      # ========================================
      - name: Checkout Runner repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Install dependencies
        run: |
          uv venv .venv
          source .venv/bin/activate
          uv pip install -e '.[openhands]'

      # ========================================
      # Sync and Clone Fork
      # ========================================
      - name: Sync fork with upstream
        run: |
          source .venv/bin/activate
          python scripts/sync_fork.py

      - name: Clone fork repository
        run: |
          git clone --depth=50 "https://x-access-token:${BOT_TOKEN}@github.com/${FORK_REPO}.git" repo
          cd repo
          git checkout -b "bot/${JOB_ID}"
          echo "BRANCH=bot/${JOB_ID}" >> "$GITHUB_ENV"

      # ========================================
      # Run Agent
      # ========================================
      - name: Run OpenHands Agent
        run: |
          source .venv/bin/activate
          python -m agent_runner.cli run --workspace repo

      # ========================================
      # Commit and Push
      # ========================================
      - name: Commit and push changes
        id: commit_push
        run: |
          source .venv/bin/activate
          python scripts/commit_push.py

      # ========================================
      # Create PR
      # ========================================
      - name: Create Pull Request
        id: create_pr
        if: success() && env.HAS_CHANGES == 'true'
        run: |
          source .venv/bin/activate
          python -m agent_runner.cli pr \
            --upstream-repo "$UPSTREAM_REPO" \
            --fork-repo "$FORK_REPO" \
            --branch "$BRANCH" \
            --job-id "$JOB_ID"

      - name: Persist PR URL
        if: success() && env.HAS_CHANGES == 'true'
        run: echo "PR_URL=${{ steps.create_pr.outputs.pr_url }}" >> "$GITHUB_ENV"

      # ========================================
      # Callbacks
      # ========================================
      - name: Send success callback
        if: (success() || env.HAS_CHANGES == 'false') && inputs.callback_url != ''
        run: |
          source .venv/bin/activate
          python -m agent_runner.cli callback \
            --callback-url "$CALLBACK_URL" \
            --job-id "$JOB_ID" \
            --status completed \
            --upstream-repo "$UPSTREAM_REPO" \
            --fork-repo "$FORK_REPO" \
            --branch "${BRANCH:-}" \
            --pr-url "${PR_URL:-}"

      - name: Send failure callback
        if: failure() && inputs.callback_url != ''
        run: |
          source .venv/bin/activate
          python -m agent_runner.cli callback \
            --callback-url "$CALLBACK_URL" \
            --job-id "$JOB_ID" \
            --status failed \
            --upstream-repo "$UPSTREAM_REPO" \
            --fork-repo "${FORK_REPO:-}" \
            --error "${WORKFLOW_ERROR:-Workflow failed. Check GitHub Actions logs for details.}"
